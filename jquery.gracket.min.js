(function(e){e.fn.gracket=function(t){e.fn.gracket.defaults={gracketClass:"g_gracket",gameClass:"g_game",roundClass:"g_round",roundLabelClass:"g_round_label",teamClass:"g_team",winnerClass:"g_winner",spacerClass:"g_spacer",currentClass:"g_current",seedClass:"g_seed",cornerRadius:15,canvasId:"g_canvas",canvasClass:"g_canvas",canvasLineColor:"#eee",canvasLineCap:"round",canvasLineWidth:2,canvasLineGap:15,roundLabels:[],src:[]};var n=this,r=typeof n.data("gracket")==="undefined"?[]:JSON.parse(n.data("gracket")),i,s,o,u=[];e.fn.gracket.settings={};var a={init:function(t){this.gracket.settings=e.extend({},this.gracket.defaults,t);if(this.gracket.settings.src.length)r=this.gracket.settings.src;this.gracket.settings.canvasId=this.gracket.settings.canvasId+"_"+(new Date).getTime();var a=document.createElement("canvas");a.id=this.gracket.settings.canvasId;a.className=this.gracket.settings.canvasClass;a.style.position="absolute";a.style.left=0;a.style.top=0;a.style.right="auto";n.addClass(this.gracket.settings.gracketClass).prepend(a);s=r.length;for(var l=0;l<s;l++){var c=f.build.round(this.gracket.settings);n.append(c);o=r[l].length;for(var h=0;h<o;h++){var p=f.build.game(this.gracket.settings),d=n.find("."+this.gracket.settings.gameClass).actual("outerHeight",{includeMargin:true}),v=f.build.spacer(this.gracket.settings,d,l,l!==0&&h===0?true:false);if(h%1==0&&l!==0)c.append(v);c.append(p);i=r[l][h].length;for(var m=0;m<i;m++){var g=f.build.team(r[l][h][m],this.gracket.settings);p.append(g);var y=g.actual("outerWidth",{includeMargin:true});if(u[l]===undefined||u[l]<y)u[l]=y;if(i===1){p.prev().remove();f.align.winner(p,this.gracket.settings,p.parent().prev().children().eq(0).actual("height"));f.listeners(this.gracket.settings,r,p.parent().prev().children().eq(1))}}}}}};var f={build:{team:function(t,n){var r=["<h3"+(typeof t.score==="undefined"?"":' title="Score: '+t.score+'"')+">",'<span class="'+n.seedClass+'">',typeof t.displaySeed==="undefined"?t.seed:t.displaySeed,"</span>","&nbsp;"+t.name+"&nbsp;","<small>",typeof t.score==="undefined"?"":t.score,"</small>","</h3>"].join("");return team=e("<div />",{html:r,"class":n.teamClass+" "+(t.id||"id_null")})},game:function(t){return game=e("<div />",{"class":t.gameClass})},round:function(t){return round=e("<div />",{"class":t.roundClass})},spacer:function(t,n,r,i){return spacer=e("<div />",{"class":t.spacerClass}).css({height:i?(Math.pow(2,r)-1)*(n/2):(Math.pow(2,r)-1)*n})},labels:function(t,r){var i=r,s,o=t.length,a,f=0;for(s=0;s<o;s++){a=s===0?i.padding+f:i.padding+f+i.right*s;e("<h5 />",{html:i.labels.length?i.labels[s]:"Round "+(s+1),"class":i["class"]}).css({position:"absolute",left:a,width:r.width}).prependTo(n);f+=u[s]}},canvas:{resize:function(t){var r=document.getElementById(t.canvasId);r.height=n.actual("innerHeight");r.width=n.actual("innerWidth");e(r).css({height:n.actual("innerHeight"),width:n.actual("innerWidth"),zIndex:1,pointerEvents:"none"})},draw:function(t,r,i){var s=document.getElementById(t.canvasId);if(typeof G_vmlCanvasManager!="undefined"){G_vmlCanvasManager.initElement(s)}var o=s.getContext("2d");var a=u[0],l=i.actual("outerHeight",{includeMargin:true}),c=parseInt(n.css("paddingLeft"))||0,h=parseInt(n.css("paddingTop"))||0,p=parseInt(i.css("marginBottom"))||0,d=a+c,v=parseInt(n.find("> div").css("marginRight"))||0,m=t.cornerRadius,g=t.canvasLineGap,y=i.actual("height")-2*i.find("> div").eq(1).actual("height");_playerHt=i.find("> div").eq(1).actual("height"),_totalItemWidth=0;if(typeof console!=="undefined")console.info("Padding Left: "+c+"px","Player/Name Width: "+a+"px","Container padding left: "+d+"px");if(m>l/3)m=l/3;if(m>v/2)m=v/2-2;if(m<=0)m=1;if(g>v/3)g=v/3;o.strokeStyle=t.canvasLineColor;o.lineCap=t.canvasLineCap;o.lineWidth=t.canvasLineWidth;o.beginPath();var b=Math.pow(2,r.length-2),w=0,E,S=.5,x=w===0&&b===1?true:false;if(x){var T=e("."+t.gameClass);var N=T.eq(T.length-1);l=N.actual("outerHeight",{includeMargin:true});a=N.actual("outerWidth",{includeMargin:true})}while(b>=1){for(E=0;E<b;E++){if(b==1)S=1;var C=x?a+c:d+_totalItemWidth+w*v,k=S*v,L=((Math.pow(2,w-1)-.5)*(w&&1)+E*Math.pow(2,w))*l+h+(x?T.find("> div").eq(1).actual("height"):_playerHt)+y/2;if(b>1){o.moveTo(C+g,L);o.lineTo(C+k-m,L)}else{o.moveTo(C+g,L);o.lineTo(C+3*g,L)}if(b>1&&E%2==0){var A=L+m;var O=L+Math.pow(2,w)*l-m;o.moveTo(C+k,A);o.lineTo(C+k,O);var M=C+k-m,_=L+m;o.moveTo(M,_-m);o.arcTo(M+m,_-m,M+m,_,m);_=L+Math.pow(2,w)*l-m;o.moveTo(M+m,_-m);o.arcTo(M+m,_+m,M,_+m,m);var D=(A+O)/2;o.moveTo(C+k,D);o.lineTo(C+k+g,D)}}w++;a=u[w];_totalItemWidth+=a;b=b/2}o.stroke();f.build.labels(r,{padding:c,left:d,right:v,labels:t.roundLabels,"class":t.roundLabelClass})}}},align:{winner:function(e,t,n){var r=e.parent().siblings().not("canvas").length===1?true:false;var i=r?n-(e.actual("height")+e.actual("height")/2):n+e.actual("height")/2;return e.addClass(t.winnerClass).css({"margin-top":i})}},listeners:function(t,n,r){var i="."+t.teamClass+" > h3";e.each(e(i),function(n){var r="."+e(this).parent().attr("class").split(" ")[1];if(r!==undefined){e(r).hover(function(){e(r).addClass(t.currentClass)},function(){e(r).removeClass(t.currentClass)})}});f.build.canvas.resize(t);f.build.canvas.draw(t,n,r)}};if(a[t]){return a[t].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof t==="object"||!t){return a.init.apply(this,arguments)}else{e.error('Method "'+t+'" does not exist in gracket!')}}})(jQuery)